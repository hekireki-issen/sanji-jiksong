name: Dev CI on WSL Runner

on:
  push:
    branches:
      - dev
  pull_request:
    branches:
      - dev

jobs:
  build-and-deploy:
    runs-on: self-hosted

    env:
      # í•„ìš”í•œ í™˜ê²½ë³€ìˆ˜ë¥¼ GitHub Secretsë¡œ ê´€ë¦¬
      DATA_REDIS_HOST: ${{ secrets.DATA_REDIS_HOST }}
      DB_URL: ${{ secrets.DB_URL }}
      DB_USERNAME: ${{ secrets.DB_USERNAME }}
      DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
      JPA_DDI: ${{ secrets.JPA_DDI }}
      JPA_DDL_AUTO: ${{ secrets.JPA_DDL_AUTO }}
      NAVER_BOOK_ID: ${{ secrets.NAVER_BOOK_ID }}
      NAVER_BOOK_SECRET: ${{ secrets.NAVER_BOOK_SECRET }}
      SQL_INIT_MODE: ${{ secrets.SQL_INIT_MODE }}

    steps:
      - name: Check out code
        uses: actions/checkout@v3

      - name: Grant execute permission to gradlew
        run: chmod +x gradlew

      - name: Run unit tests
        run: ./gradlew test

      - name: Stop existing app (systemd)
        if: ${{ success() }}
        run: |
          sudo systemctl stop sz_service || echo "ì„œë¹„ìŠ¤ê°€ ì•ˆ ì¼œì ¸ ìˆì—ˆìŒ"

      - name: Build new JAR
        if: ${{ success() }}
        run: ./gradlew build -x test

      - name: Deploy new JAR using systemd service
        if: ${{ success() }}
        run: |
          echo "ğŸ“¦ í˜„ì¬ ë””ë ‰í† ë¦¬: $(pwd)"
          echo "ğŸ“ libs ë‚´ë¶€ íŒŒì¼ ëª©ë¡:"
          ls -lh build/libs
          echo "ğŸš€ Spring Boot ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰ ì¤‘..."
          
          sudo systemctl stop sz_service || echo "ì„œë¹„ìŠ¤ê°€ ì•ˆ ì¼œì ¸ ìˆì—ˆìŒ"
          sudo systemctl start sz_service
          
          sudo systemctl daemon-reload
          sudo systemctl enable newapp.service
          sudo systemctl start newapp.service
          sleep 5
          head -n 100 app.log || echo "(ë¡œê·¸ ì—†ìŒ)"

      - name: Check if app is running
        if: ${{ success() }}
        run: |
          echo "ğŸ” ì‹¤í–‰ ì¤‘ì¸ Java í”„ë¡œì„¸ìŠ¤:"
          pgrep -af 'java'
          
          
      - name: Restart Spring Boot service
        if: ${{ success() }}
        run: |
          echo "Spring Boot ì„œë¹„ìŠ¤ê°€ ì¬ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤."
